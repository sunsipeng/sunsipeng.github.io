<!DOCTYPE HTML>
<html>
 <head>
  <title>recording the audio</title>
  <meta name="Generator" content="EditPlus">  
  <meta name="keywords" content="思鹏代码库,思鹏工作室,思鹏社区,思鹏科技,免费前端特效分享,比较全的代码库,代码博客,思鹏博客" />
  <meta name="description" content="思鹏代码库是作者思鹏对自己学习知识点的一个总结和归纳,欢迎业界的朋友们来到思鹏代码库进行学习和交流,思鹏始终相信,程序可以改变一切。http://sipeng.net/" />

 </head>

 <body>
  <h1>>Record the Audio</h1>
  
  <audio controls src='' id='audioDom'>
   
   您的浏览器不支持 audio 元素。
 </audio>
 </body> 
 <script src="RecordRTC.js"></script>
 <script>
  if(!window.RecordAudio){
    function RecordAudio(){
      this.recorder = null;
      this.getMicroPhone = null;
      this.recorderFlag = true;
    }
    RecordAudio.prototype.init = function(){
      
    }
    RecordAudio.prototype.startRecording = function (){
      var startRecordingHandler = () => {
        var options = {
          type: 'audio',
          numberOfAudioChannels:  2,
          checkForInactiveTracks: true,
          bufferSize: 16384
        };
        if(navigator.platform && navigator.platform.toString().toLowerCase().indexOf('win') === -1) {
          options.sampleRate = 48000;
        }
        if(this.recorder) {
          this.recorder.destroy();
          this.recorder = null;
        }
        this.recorder = window.RecordRTC(this.getMicroPhone, options);
        this.recorder.startRecording();
      };

      if (!this.getMicroPhone) {
        this.captureMicrophone((mic) => {
          this.getMicroPhone = mic;
          startRecordingHandler();
        });
        return;
      }
      startRecordingHandler();
    }
    RecordAudio.prototype.captureMicrophone = function (callback){
      if(this.getMicroPhone) {
        callback(this.getMicroPhone);
        return;
      }
      if(typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
        if(navigator.getUserMedia) {
          alert('您的浏览器暂不支持录音功能（4003）');
        }
        alert('您的浏览器暂不支持录音功能（5002）');
        return;
      }
      navigator.mediaDevices.getUserMedia({
        audio: true
      }).then( (mic) => {
        callback(mic);
      }).catch((err) => {
       console.log(err);
        alert('当前浏览器暂不支持语音录入（4006）');
      });;
    }

    RecordAudio.prototype.stopRecording = function() {
      this.recorder && this.recorder.stopRecording(function(){
        this.uploadAudioFile(this.recorder.getBlob());  
      }.bind(this));
    }

    RecordAudio.prototype.uploadAudioFile = function(soundBlob) {
      let formdata = new FormData();
      formdata.append('file', soundBlob);
     console.log(soundBlob);
     var blob=new Blob([soundBlob], {type : 'audio/webm'});
     var blobUrl = URL.createObjectURL(blob);
     console.log(blobUrl, 'URL');
     document.getElementById('audioDom').setAttribute('src', blobUrl);
    }

    RecordAudio.prototype.convertDataURIToBinary = function (dataURI) {
        var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
        var base64 = dataURI.substring(base64Index);
        var raw = window.atob(base64);
        var rawLength = raw.length;
        var array = new Uint8Array(new ArrayBuffer(rawLength));

        for(i = 0; i < rawLength; i++) {
          array[i] = raw.charCodeAt(i);
        }
        return array;
      }
      window.$recordAudio = new RecordAudio();
    }
 </script>
</html>
