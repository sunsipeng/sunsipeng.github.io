<!DOCTYPE HTML>
<html>
 <head>
  <title>recording the audio</title>
  <meta name="Generator" content="EditPlus">  
  <meta name="keywords" content="" />
  <meta name="description" content="http://sipeng.net/" />

 </head>

 <body>
  <h1>>Record the Audio</h1>
  
  <br />
  <button onclick='window.$recordAudio.startRecording()'>start recording</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <button onclick='window.$recordAudio.stopRecording()'>stop recording</button>
  <br />
  
  <audio controls src='' id='audioDom'>
   
   您的浏览器不支持 audio 元素。
 </audio>
 </body> 
 <script src="RecordRTC.js"></script>
 <script src="FileSaver.min.js"></script>
 <script>
  if(!window.RecordAudio){
    function RecordAudio(){
      this.recorder = null;
      this.getMicroPhone = null;
      this.recorderFlag = true;
    }
    RecordAudio.prototype.init = function(){
      
    }
    RecordAudio.prototype.startRecording = function (){
      var self = this;
      var startRecordingHandler = function () {
        var options = {
          type: 'audio',
          numberOfAudioChannels:  2,
          checkForInactiveTracks: true,
          bufferSize: 16384,
          mimeType: 'audio/wav',
          timeSlice: 4000
        };
        if(navigator.platform && navigator.platform.toString().toLowerCase().indexOf('win') === -1) {
          options.sampleRate = 48000;
        }
        if(self.recorder) {
          self.recorder.destroy();
          self.recorder = null;
        }
        self.recorder = window.RecordRTC(self.getMicroPhone, options);
        self.recorder.startRecording();
      };

      if (!this.getMicroPhone) {
        this.captureMicrophone((mic) => {
          this.getMicroPhone = mic;
          startRecordingHandler();
        });
        return;
      }
      startRecordingHandler();
    }
    RecordAudio.prototype.captureMicrophone = function (callback){
      if(this.getMicroPhone) {
        callback(this.getMicroPhone);
        return;
      }
      if(typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
        if(navigator.getUserMedia) {
          alert('您的浏览器暂不支持录音功能（4003）');
        }
        alert('您的浏览器暂不支持录音功能（5002）');
        return;
      }
      navigator.mediaDevices.getUserMedia({
        audio: true
      }).then(function (mic) {
        callback(mic);
      }).catch(function (err) {
        console.log(err);
        alert('当前浏览器暂不支持语音录入（4006）');
      });;
    }

    RecordAudio.prototype.stopRecording = function() {
      this.recorder && this.recorder.stopRecording(function(){
        this.uploadAudioFile(this.recorder.getBlob());  
      }.bind(this));
    }

    RecordAudio.prototype.uploadAudioFile = function(soundBlob) {
      let formdata = new FormData();
      formdata.append('file', soundBlob);
     console.log(soundBlob);
     var blob = new Blob([soundBlob], {type : 'audio/wav'});
     var blobUrl = URL.createObjectURL(blob);
     console.log(blobUrl, 'URL');
     document.getElementById('audioDom').setAttribute('src', blobUrl);
     this.downloadFile(soundBlob);
    }
    RecordAudio.prototype.downloadFile = function(blob) {
      //FileSaver.saveAs(blob, "my-voice.wav");
     invokeSaveAsDialog(blob, 'my-voice.wav');
    }
   

    RecordAudio.prototype.convertDataURIToBinary = function (dataURI) {
        var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
        var base64 = dataURI.substring(base64Index);
        var raw = window.atob(base64);
        var rawLength = raw.length;
        var array = new Uint8Array(new ArrayBuffer(rawLength));

        for(i = 0; i < rawLength; i++) {
          array[i] = raw.charCodeAt(i);
        }
        return array;
      }
      window.$recordAudio = new RecordAudio();
    }
 </script>
</html>
